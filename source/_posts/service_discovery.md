---
title: 服务发现架构设计
categories: 软件工程
---



## 引言

当客户端的请求到达HTTP服务器后, 服务器会调用RPC服务, RPC服务之间也可能会相互调用, 这个时候, 调用者就需要知道这些服务调用的网络地址. 

* 服务发现就是为了让每个服务知道所有可调用服务的网络地址.

* 服务发现一般用一个**服务注册中心**实现:
  * 服务注册中心负责管理每个可调用服务的地址.
  * 服务启动后, 会自动将地址注册到服务注册中心.
  * 服务推出时, 会在服务注册中心注销 .
  * 如果服务地址出现变动, 服务注册中心会推送所有的调用者.
  * <font color=red>服务注册中心应该具有对已注册服务的探活能力, 防止服务挂掉, 但是没来得及注销.</font>



## 服务探活

* 服务注册中心有两种方式对已注册服务进行探活:
  * 轮询: 服务注册中心周期性地向已注册服务发送探测请求.
    * 大体量的服务, 一般已注册的服务巨多, 采用这种方式不现实.
  * 心跳检测: 
    * 服务注册中心为每个服务记录一个最近心跳时间, 并启动定时器.
    * 服务每隔一段时间就像服务注册中心发送心跳包.
    * 服务注册中心收到心跳包后, 更新最近心跳时间, 并重启定时器.
    * 如果超时, 那么服务不可用, 服务注册中心将地址摘除.

> 心跳检测的危险之处?

* 如果服务注册中心的摘除逻辑有bug, 导致所有服务均被摘除, 那么服务就会瘫痪.
* 如果网络出现故障, 但是服务本身没挂, 心跳包有可能会晚到服务注册中心, 也可能导致服务注册中心摘除.
  * 此时, 如果服务的总QPS过高, 就会把剩余的服务全部压垮, 导致故障.
* **解决方案:** 在服务摘除到了某一个阈值时, 停止摘除, 并且告警.

## 地址变更推送

* 如果出现了服务地址变更, 需要有一种机制让所有调用者知道, 但是调用者很可能有多个服务, 每个服务还有可能有多个实例, 推送可能严重占用网络带宽.

* 解决方式:
  * 部署多个服务注册中心, 分摊到每一个中心的推送量会减少.
  * 推送的数据形式是增量形式 (新增/废除了哪些地址), 减少带宽压力.
  * 只给某些服务推送, 其他服务可以周期性拉取.